<!--
   Except as noted,
   Copyright 2011 Kevin Reid, under the terms of the MIT License as detailed in
   the accompanying file README.md or <http://opensource.org/licenses/MIT>.
  
   Exception: The overall structure of WebGL initialization and context
   management is copied from Learning WebGL, Lesson 16, at
   http://learningwebgl.com/blog/?p=1786 (as of September 2011). No license is
   stated on that site, but I (Kevin Reid) believe that it is obviously the
   authors' intent to make this code free to use.
-->
<!doctype html>
<html><head>
<title>Cubes</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width">
<link rel="stylesheet" href="style.css" type="text/css">

<script type="text/javascript" src="webgl-debug.js"></script>
<script type="text/javascript" src="webgl-utils.js"></script>
<script type="text/javascript" src="glMatrix.js"></script>
<script type="text/javascript" src="util.js"></script>
<script type="text/javascript" src="storage.js"></script>

<script type="text/javascript" src="main.js"></script> <!-- before other stuff because of config global — TODO fix -->

<script type="text/javascript" src="blockset.js"></script>
<script type="text/javascript" src="world.js"></script>
<script type="text/javascript" src="world-gen.js"></script>
<script type="text/javascript" src="circuit.js"></script>
<script type="text/javascript" src="renderer.js"></script>
<script type="text/javascript" src="world-render.js"></script>
<script type="text/javascript" src="block-render.js"></script>
<script type="text/javascript" src="player.js"></script>
<script type="text/javascript" src="input.js"></script>
<script type="text/javascript" src="audio.js"></script>

<script type="text/javascript">
    var main = new CubesMain(1/60 /* timestep */);
</script>


</head>


<body onload="main.start();">
    <div class="overlay-bounds">
      <canvas id="view-canvas" tabindex="0" class="viewport" width="640" height="480">
        <div class="error-notice">
          <p>Sorry, but the web browser you are using does not appear to support WebGL (or even Canvas).</p>
        </div>
      </canvas>
      <div id="scene-info-overlay" class="overlay">
        <pre id="scene-info-text">Not ready...</pre>
        <div class="progress-bar" id="chunks-progress-bar" style="width: 20em;"></div>
        <div class="progress-bar" id="audio-progress-bar" style="width: 20em;"></div>
        <div class="progress-bar" id="persistence-progress-bar" style="width: 20em;"></div>
      </div>
      <pre id="cursor-info" class="overlay"></pre>
      <div id="menu-container">
        <div id="menu">
          <!-- dynamic content -->
        </div>
      </div>
    </div>
    <div id="error-notices">
    <div id="load-error-notice" class="error-notice" style="display: none;">
      <p>Sorry, but there was an unexpected error while loading the game.</p>
      <p><pre id="load-error-text" style="white-space: pre-wrap;"></pre></p>
    </div>
    <div id="feature-error-notice" class="error-notice" style="display: none;">
      <p>Sorry, the browser you are using does not support some required features. These problems were detected:</p>
      <p><pre id="feature-error-text" style="white-space: pre-wrap;"></pre></p>
      <p>If you are looking for a compatible browser, I recommend Google Chrome.</p>
    </div>
    <div id="webgl-error-notice" class="error-notice" style="display: none;">
      <p>Sorry, the web browser you are using does not appear to support WebGL.</p>
    </div>
    </div>

    <div id="toggles">
      <button id="save-button" onclick="main.save(); document.getElementById('view-canvas').focus(); return false;">Save</button>
      <button id="optionsbtn" onclick="this.style.display='none'; document.getElementById('options').style.display='block'; document.getElementById('view-canvas').focus();">Options</button>
      <button id="helpbtn" onclick="this.style.display='none'; document.getElementById('help').style.display='block'; document.getElementById('view-canvas').focus();">Help</button>
    </div>

    <div id="options" class="sidebar" onclick="if (event.target.tagName == 'INPUT' || event.target.tagName == 'LABEL' || event.target.tagName == 'BUTTON' || event.target.tagName == 'TEXTAREA') return true; this.style.display='none'; document.getElementById('optionsbtn').style.display='inline'; document.getElementById('view-canvas').focus();" style="display: none;">
      <p>Click to close.</p>

      <h2>Load/Save</h2>
      
      <form onsubmit="return false;" action="" style="text-align: center">
        <div id="local-save-ok" style="display: none">
          <div class="optionline">World:</div>
          <select id="world-select" size="5" style="width: 90%;"><option>not loaded</option></select>
          <p>Your browser supports local storage. This world will be saved automatically.</p>
        </div>
        <p id="local-save-warning" style="display: none">
          Your browser does not appear to support local storage. This world will be lost when you close the page unless you export it and save the text.
        </p>
        <p style="">
          <textarea id="loadfield" width="20" height="3" style="width: 80%;"></textarea>
          <br>
          <button onclick="
            document.getElementById('loadfield').value = JSON.stringify(cyclicSerialize(main.getTopWorld(), Persister.types)); return false;
          ">Text Export</button>
          <button onclick="
            while (document.getElementById('load-error').firstChild)
              document.getElementById('load-error').removeChild(
                document.getElementById('load-error').firstChild);
            try {
              main.setTopWorld(cyclicUnserialize(JSON.parse(document.getElementById('loadfield').value), Persister.types));
            } catch (e) {
              console.log(e);
              document.getElementById('load-error').appendChild(document.createTextNode(e));
            }
            return false;
          ">Text Import</button>
          <br>
          <div id="load-error" style="text-shadow: 0 0 .3em red;"></div>
        </p>
      </form>
      
      <h2>World</h2>

      <form onsubmit="return false;" action="">
        <table class="optionline">
          <tr><td>Name:<td><input id="generate_name" type="text" value="" style="width: 95%;">
            <p id="generate-name-conflict" style="display: none;" class="error">Name already in use.</p>
          <tr><td>Shape: 
          <td><select id="generate_shape">
            <option value="fill">Flat-sided</option>
            <option value="island">Floating island</option>
            <option value="city">City</option>
          </select>
          <tr><td>Bumpiness:<td><input type="range" step="any" min="0" max="2" value="1" maxlength="4" size="4" id="generate_slope">
          <tr><td>Block res.:<td><input type="number" min="2" value="16" size="3" maxlength="4" step="1" id="generate_tileSize">
        </table>
        <script>config.generate_name.bindControl("generate_name");</script>
        <script>config.generate_shape.bindControl("generate_shape");</script>
        <script>config.generate_slope.bindControl("generate_slope");</script>
        <script>config.generate_tileSize.bindControl("generate_tileSize");</script>
        <table class="optionline" style="text-align: center;">
          <tr><td>Size: 
          <td><input type="number" min="1" max="9999" value="400" maxlength="4" size="4" id="generate_wx">
          <td><input type="number" min="1" max="512" value="128" maxlength="3" size="3" id="generate_wy">
          <td><input type="number" min="1" max="9999" value="400" maxlength="4" size="4" id="generate_wz">
          <tr><th><th>W<th>H<th>L
        </table>
        <script>config.generate_wx.bindControl("generate_wx");</script>
        <script>config.generate_wy.bindControl("generate_wy");</script>
        <script>config.generate_wz.bindControl("generate_wz");</script>
        <div style="text-align: center;">
          <button onclick="
            main.regenerate();
            return false;
          ">Generate new world</button>
        </div>
      </form>

      <h2>Options</h2>

      <form onsubmit="return false;" action="">
        <div class="optionline">Field of view: <input type="range" step="any" min="45" max="140" value="60" maxlength="4" size="4" id="fov"></div>
        <script>config.fov.bindControl("fov");</script>
        <div class="optionline">Draw distance: <input type="range" step="any" min="10" max="500" value="100" size="4" id="renderDistance"></div>
        <script>config.renderDistance.bindControl("renderDistance");</script>
        <div class="optionline">Turn rate: <input type="range" step="any" min="0" max="10" value="5" size="4" id="mouseTurnRate"></div>
        <script>config.mouseTurnRate.bindControl("mouseTurnRate");</script>
        <div class="optionline"><label><input type="checkbox" id="lighting"> Lighting</label></div>
        <script>config.lighting.bindControl("lighting");</script>
        <div class="optionline"><label><input type="checkbox" id="bumpMapping"> Bump mapping</label></div>
        <script>config.bumpMapping.bindControl("bumpMapping");</script>
        <div class="optionline"><label><input type="checkbox" id="enableSound"> Sound</label></div>
        <script>
          document.getElementById("enableSound").disabled = !CubesAudio.audioSupported;
          config.sound.bindControl("enableSound");
        </script>
        
        <h3>Debug</h3>
        
        <div class="optionline"><label><input type="checkbox" id="debugForceRender"> Always render frames</label></div>
        <script>config.debugForceRender.bindControl("debugForceRender");</script>
        <div class="optionline"><label><input type="checkbox" id="debugTextureAllocation"> Show block texture</label></div>
        <script>config.debugTextureAllocation.bindControl("debugTextureAllocation");</script>
        <div class="optionline"><label><input type="checkbox" id="debugPlayerCollision"> Show collision volumes</label></div>
        <script>config.debugPlayerCollision.bindControl("debugPlayerCollision");</script>
        <div class="optionline"><label><input type="checkbox" id="alwaysGenerateWorld"> Regenerate world on reload</label></div>
        <script>config.alwaysGenerateWorld.bindControl("alwaysGenerateWorld");</script>
        <div class="optionline"><label><input type="checkbox" id="noclip"> Noclip</label></div>
        <script>config.noclip.bindControl("noclip");</script>

        <p><button onclick="config.resetAllOptions(); return false;">Reset to defaults</button></p>
      </form>
    </div>

    <div id="help" class="sidebar" onclick="this.style.display='none'; document.getElementById('helpbtn').style.display='inline'; document.getElementById('view-canvas').focus();" style="display: none;">
      <h2>Help</h2>
      
      <p>Click to close this help.</p>
      
      <h3>Controls</h3>
      
      <table class="fancy">
        <tr><th colspan=2>Movement
        <tr><td><kbd>W</kbd> <kbd>A</kbd> <kbd>S</kbd> <kbd>D</kbd><br> or arrows<td>move horizontally
        <tr><td><kbd>Space</kbd><td>jump
        <tr><td><kbd>E</kbd><td>fly, move up
        <tr><td><kbd>C</kbd><td>land, move down
        <tr><td><kbd>Q</kbd><td>toggle mouselook
        <tr><th colspan=2>Blocks
        <tr><td>Left button<td> remove block
        <tr><td>Right button<td> place block
        <tr><td><kbd>Q</kbd><td> toggle block menu
        <tr><td><kbd>1</kbd>–<kbd>9</kbd>, <kbd>0</kbd><td>choose from menu
        <tr><td><kbd>R</kbd><td> edit targeted block
        <tr><td>Right button in menu<td> edit clicked block
        <tr><td><kbd>Esc</kbd>, <kbd>F</kbd><td> exit editing
      </table>

      <p>While you can edit any block to any shape, note that making the first block type (which makes up the underground volume in the default world) a non-cubical shape will likely be fatal to your frame rate.</p>

      <h3>Compatibility &amp; Bugs</h3>
      
      <p>Player movement does not work on Safari 5.1.</p>
      
      <p>On an older MacBook Pro with 10.7 “Lion”, the terrain may be entirely white and the game may crash (exiting the browser in Firefox, a permanently gray screen in Chrome).</p>

    </div>
</body>

</html>
